<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="SCTF low_re       这个题其实算是逆向题, 考虑到这个题不是常规逆向思路, 并且有点谜语, 所以我把这个题放misc里面了.">
<meta property="og:type" content="article">
<meta property="og:title" content="SCTF low_re">
<meta property="og:url" content="https://yimianweishi.github.io/2022/01/04/SCTF-low-re/index.html">
<meta property="og:site_name" content="marginal&#39;s blog">
<meta property="og:description" content="SCTF low_re       这个题其实算是逆向题, 考虑到这个题不是常规逆向思路, 并且有点谜语, 所以我把这个题放misc里面了.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-01-04T12:10:13.000Z">
<meta property="article:modified_time" content="2022-01-04T13:06:04.117Z">
<meta property="article:author" content="marginal">
<meta name="twitter:card" content="summary"><title>SCTF low_re | marginal's blog</title><link ref="canonical" href="https://yimianweishi.github.io/2022/01/04/SCTF-low-re/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">marginal's blog</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">SCTF low_re</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-04</span></span></div></header><div class="post-body">
        <h2 id="SCTF-low-re"   >
          <a href="#SCTF-low-re" class="heading-link"><i class="fas fa-link"></i></a><a href="#SCTF-low-re" class="headerlink" title="SCTF low_re"></a>SCTF low_re</h2>
      <p>这个题其实算是逆向题, 考虑到这个题不是常规逆向思路, 并且有点谜语, 所以我把这个题放misc里面了.  </p>
<span id="more"></span>

<p>出题人比较菜, 如果给师傅们造成了不好的体验, 轻点骂, orz.</p>
<p>这个题目的预期解是通过pintool之类的插桩工具进行指令计数来进行爆破, 但是我也看到有一些师傅使用钩子来获得信息的一些思路, 甚至于做了一些vmp的逆向, 师傅们tql. </p>

        <h3 id="出题思路"   >
          <a href="#出题思路" class="heading-link"><i class="fas fa-link"></i></a><a href="#出题思路" class="headerlink" title="出题思路"></a>出题思路</h3>
      
        <h4 id="首先python源代码"   >
          <a href="#首先python源代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#首先python源代码" class="headerlink" title="首先python源代码"></a>首先python源代码</h4>
      <p>这里是单字节加密(所以可以使用侧信道爆破)</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def _rc4_crypt(key, data, dataLen):</span><br><span class="line">    out = []</span><br><span class="line">    s_box = list(range(256))</span><br><span class="line">    j = 0</span><br><span class="line">    for i in range(256):</span><br><span class="line">        j = (j + s_box[i] + ord(key[i % len(key)])) % 256</span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line"></span><br><span class="line">    for x in range(dataLen):</span><br><span class="line">        i = (i + 1) % 256</span><br><span class="line">        j = (j + s_box[i]) % 256</span><br><span class="line">        t = s_box[i]</span><br><span class="line">        s_box[i] = s_box[j]</span><br><span class="line">        s_box[j] = t</span><br><span class="line">        ti = (s_box[i] + (s_box[j] % 256)) % 256</span><br><span class="line">        t = s_box[ti]</span><br><span class="line">        while (len(out) &lt; x + 1):</span><br><span class="line">            out.append(0)</span><br><span class="line">        out[x] = data[x] ^ t</span><br><span class="line">    return out</span><br><span class="line"></span><br><span class="line">def linux_srand(seed):</span><br><span class="line">    if seed == 0:</span><br><span class="line">        seed = 1</span><br><span class="line">    word = seed</span><br><span class="line">    seed = seed &amp; 0xffffffff</span><br><span class="line">    global linux_status</span><br><span class="line">    global linux_r</span><br><span class="line">    linux_status = 0</span><br><span class="line">    linux_r = [0] * (344 + linux_status)</span><br><span class="line">    linux_r[0] = seed</span><br><span class="line">    for i in range(1, 31):</span><br><span class="line">        if (word &lt; 0):</span><br><span class="line">            hi = (-word) // 127773</span><br><span class="line">            hi = -hi</span><br><span class="line">            lo = (-word) % 127773</span><br><span class="line">            lo = -lo</span><br><span class="line">        else:</span><br><span class="line">            hi = word // 127773</span><br><span class="line">            lo = word % 127773</span><br><span class="line">        word = ((16807 * lo)) - ((2836 * hi))</span><br><span class="line">        if word &lt; 0:</span><br><span class="line">            word = (2147483647 + word) &amp; 0xffffffff</span><br><span class="line">        linux_r[i] = word</span><br><span class="line">    for i in range(31, 34):</span><br><span class="line">        linux_r[i] = linux_r[i - 31]</span><br><span class="line">    for i in range(34, 344):</span><br><span class="line">        linux_r[i] = (((linux_r[i - 31] + linux_r[i - 3]) &amp; 0xffffffff) % (1 &lt;&lt; 32)) &amp; 0xffffffff</span><br><span class="line"></span><br><span class="line">def linux_rand():</span><br><span class="line">    global linux_status</span><br><span class="line">    global linux_r</span><br><span class="line">    linux_r.append(0)</span><br><span class="line">    linux_r[344 + linux_status] = (((linux_r[344 + linux_status - 31] + linux_r[344 + linux_status - 3]) &amp; 0xffffffff) % (1 &lt;&lt; 32)) &amp; 0xffffffff</span><br><span class="line">    linux_status += 1</span><br><span class="line">    return linux_r[344 + linux_status - 1] &gt;&gt; 1</span><br><span class="line">print(&quot;hello challanger&quot;)</span><br><span class="line">flag = input(&quot;please input your flag:\n&quot;)</span><br><span class="line">if (type(flag) != str):</span><br><span class="line">    print(&quot;error&quot;)</span><br><span class="line">    sys.exit()</span><br><span class="line">if (len(flag) != 17):</span><br><span class="line">    sys.exit()</span><br><span class="line">flag = list(bytes(flag, encoding=&#x27;utf-8&#x27;))</span><br><span class="line">flag = _rc4_crypt(&#x27;Sycl0ver&#x27;, flag, len(flag))</span><br><span class="line">for i in range(len(flag)):</span><br><span class="line">    linux_srand(flag[i])</span><br><span class="line">    flag[i] = str(linux_rand())</span><br><span class="line">ciphertext=[&#x27;ee197bbac1b0e09c425e1dfd30cea2506bd493a674c4de90d9afbe5abc700b06&#x27;,</span><br><span class="line">&#x27;1a6aafb16a23ffde40c426d5c87f5afcc77fffc96cf041dc8dd2c47e706a7ecb&#x27;,</span><br><span class="line">&#x27;62c62ce7768a4836b10495317a32da6e3943d522bc3b9797ff0a44931e966a31&#x27;,</span><br><span class="line">&#x27;e6222354b50e4d33d73314b515b325633e57a105758e20aca23eb2dadd625f3f&#x27;,</span><br><span class="line">&#x27;78f92a6ad9ffcec47f30e3ca3d18065bdba9c020ff5f477b801d11efdfaa9cd0&#x27;,</span><br><span class="line">&#x27;127291de1f4cbbb35c41556a3c6d5a64f08661bc7ed394ea6210354e6218ad93&#x27;,</span><br><span class="line">&#x27;62c62ce7768a4836b10495317a32da6e3943d522bc3b9797ff0a44931e966a31&#x27;,</span><br><span class="line">&#x27;52080868c07a9ef5646b5f0b198f04f013cf23cfbfb06123d8f2fdd63d359123&#x27;,</span><br><span class="line">&#x27;f69b52599973fc5915ad1d435236863252dc3fd460989bd9f56ffc199ef8ff36&#x27;,</span><br><span class="line">&#x27;e9552f8c3e518306524fa9c9728ad6dee88fa611aa3068c169217f173964f9b4&#x27;,</span><br><span class="line">&#x27;54cb43f463ea082699131b71d45fb0384f8c2f598e8f0072b960b4add731e048&#x27;,</span><br><span class="line">&#x27;97e45e15c74f71ea59ffffb40298f2e5dec119c2205e434e3a0d2510c331037f&#x27;,</span><br><span class="line">&#x27;51b7d78cfe25ede262fd85a65b24721f076ab9dd6562403878ca5cde1ebf3219&#x27;,</span><br><span class="line">&#x27;a1cd6c7990abb6b271695381d78898ec5c4880fbc0f6a0c9fda064422f21361e&#x27;,</span><br><span class="line">&#x27;85ddd3721d173367465373f75e190bd937a8dc3588d5d82ebff8104dec88ac3e&#x27;,</span><br><span class="line">&#x27;d6eeac4ea40f9513391ef0bf72aa2fd2588889cb9d5f4cc638ce4d2c5509527b&#x27;,</span><br><span class="line">&#x27;5023939dca9273fd767d5e4ea329846f9816af461e170b6db8d20b6e5ff3de8c&#x27;]</span><br><span class="line">for i in range(len(flag)):</span><br><span class="line">    for j in range(2560):</span><br><span class="line">        s = hashlib.sha256()</span><br><span class="line">        s.update(bytes(flag[i], encoding=&#x27;utf-8&#x27;))</span><br><span class="line">        flag[i] = s.hexdigest()</span><br><span class="line">    #print(&quot;&#x27;&quot; + flag[i]+ &quot;&#x27;,&quot;)</span><br><span class="line">    if (flag[i] != ciphertext[i]):</span><br><span class="line">        sys.exit()</span><br><span class="line">print(&quot;you are right&quot;)</span><br><span class="line">sys.exit()</span><br></pre></td></tr></table></div></figure>


        <h4 id="混淆python"   >
          <a href="#混淆python" class="heading-link"><i class="fas fa-link"></i></a><a href="#混淆python" class="headerlink" title="混淆python"></a>混淆python</h4>
      <p>使用python pyminifier的混淆功能去混淆python代码</p>
<p>虽然有一种乱码混淆, 但是可能会导致这样那样的问题, 我就没有使用了</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyminifier --obfuscate</span><br></pre></td></tr></table></div></figure>

<p> 混淆出来之后可能点错误, 手动改改就ok了.</p>

        <h4 id="转化为C代码并且编译"   >
          <a href="#转化为C代码并且编译" class="heading-link"><i class="fas fa-link"></i></a><a href="#转化为C代码并且编译" class="headerlink" title="转化为C代码并且编译"></a>转化为C代码并且编译</h4>
      <p>在文件的开头记得加上python3的声明 不然会转化失败</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cython: language_level=3</span><br></pre></td></tr></table></div></figure>

<p>网上python的一个GCC编译exe的脚本</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">import sys</span><br><span class="line">import tempfile</span><br><span class="line">from Cython.Compiler import Main, CmdLine, Options</span><br><span class="line"></span><br><span class="line">in_file_name = sys.argv[1]</span><br><span class="line">source = open(in_file_name).read()</span><br><span class="line">out_file_name = in_file_name.replace(&#x27;.py&#x27;, &#x27;.exe&#x27;)</span><br><span class="line"></span><br><span class="line">temp_py_file = tempfile.NamedTemporaryFile(suffix=&#x27;.py&#x27;, delete=False)</span><br><span class="line">temp_py_file.write(source.encode())</span><br><span class="line">temp_py_file.flush()</span><br><span class="line"></span><br><span class="line">Main.Options.embed = &#x27;main&#x27;</span><br><span class="line">res = Main.compile_single(temp_py_file.name, Main.CompilationOptions(), &#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">gcc_cmd = &#x27;gcc -static -municode -DMS_WIN64 -fPIC -O2 %s -Id:\\Python\\Python38\\include -Ld:\\Python\\Python38\\libs -lpython38 -o %s&#x27; % (res.c_file, out_file_name)</span><br><span class="line"></span><br><span class="line">print(gcc_cmd)</span><br><span class="line">assert 0 == subprocess.check_call(gcc_cmd.split(&#x27; &#x27;))</span><br></pre></td></tr></table></div></figure>

<p>这里的unicode是因为winmain, 如果不用unicode会报错.</p>
<p>这样就生成了exe</p>

        <h4 id="vmp加壳"   >
          <a href="#vmp加壳" class="heading-link"><i class="fas fa-link"></i></a><a href="#vmp加壳" class="headerlink" title="vmp加壳"></a>vmp加壳</h4>
      <p>网上找一个”学习”版的加壳软件, 关闭内存保护, 这样就可以进行插桩了.</p>

        <h3 id="题解"   >
          <a href="#题解" class="heading-link"><i class="fas fa-link"></i></a><a href="#题解" class="headerlink" title="题解"></a>题解</h3>
      
        <h4 id="侧信道爆破工具构建"   >
          <a href="#侧信道爆破工具构建" class="heading-link"><i class="fas fa-link"></i></a><a href="#侧信道爆破工具构建" class="headerlink" title="侧信道爆破工具构建"></a>侧信道爆破工具构建</h4>
      <p>师傅们基本上都是用的官方给的代码来构建, 但是pin官方给的指令计数是算了库的, 这样的话计算出来的指令正常波动就会非常大, 所以我使用了2560次的hash加密, 希望能够使得正确答案的指令大小更为明显, 但是我自己爆破的时候, 如果从头开始爆破, 在得到最后几个字符的时候可能会发生错误. 在和小组另外一个师傅的交流之后, 发现如果不计算库的时候指令波动会非常小.</p>

        <h5 id="pin"   >
          <a href="#pin" class="heading-link"><i class="fas fa-link"></i></a><a href="#pin" class="headerlink" title="pin"></a>pin</h5>
      <p>下载地址<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/articles/tool/pin-a-binary-instrumentation-tool-downloads.html" >https://www.intel.com/content/www/us/en/developer/articles/tool/pin-a-binary-instrumentation-tool-downloads.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>pin工具可以实现不算库的爆破, 但是官方好像没有给不计算库的指令的代码, 需要自己去写判断, 这里我做的限制条件是 exe的首地址 &lt;= 需要计数指令的地址 &lt;= exe的结束地址.</p>
<p>source/MyPinTool/MyPinTool.cpp: (用VS打开.vcxproj后缀文件就可以进行写代码了)</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright 2002-2020 Intel Corporation.</span><br><span class="line"> *</span><br><span class="line"> * This software is provided to you as Sample Source Code as defined in the accompanying</span><br><span class="line"> * End User License Agreement for the Intel(R) Software Development Products (&quot;Agreement&quot;)</span><br><span class="line"> * section 1.L.</span><br><span class="line"> *</span><br><span class="line"> * This software and the related documents are provided as is, with no express or implied</span><br><span class="line"> * warranties, other than those that are expressly stated in the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"> /*! @file</span><br><span class="line">  *  This file contains an ISA-portable PIN tool for counting dynamic instructions</span><br><span class="line">  */</span><br><span class="line"></span><br><span class="line">#include &quot;pin.H&quot;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">using std::cerr;</span><br><span class="line">using std::endl;</span><br><span class="line"></span><br><span class="line">/* ===================================================================== */</span><br><span class="line">/* Global Variables */</span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br><span class="line">UINT64 ins_count = 0;</span><br><span class="line">bool runing = false;</span><br><span class="line">UINT64 exe_start;</span><br><span class="line">UINT64 exe_size;</span><br><span class="line">/* ===================================================================== */</span><br><span class="line">/* Commandline Switches */</span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br><span class="line">/* ===================================================================== */</span><br><span class="line">/* Print Help Message                                                    */</span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br><span class="line">INT32 Usage()</span><br><span class="line">&#123;</span><br><span class="line">    cerr &lt;&lt; &quot;This tool prints out the number of dynamic instructions executed to stderr.\n&quot;</span><br><span class="line">        &quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">    cerr &lt;&lt; KNOB_BASE::StringKnobSummary();</span><br><span class="line"></span><br><span class="line">    cerr &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    return -1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br><span class="line">VOID docount() &#123; ins_count++; &#125; </span><br><span class="line"></span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br><span class="line">VOID Instruction(INS ins, VOID* v) </span><br><span class="line">&#123; </span><br><span class="line">    ADDRINT addr = INS_Address(ins);</span><br><span class="line">    if (exe_start &lt;= addr &amp;&amp; addr &lt;= exe_start + exe_size) //判断指令是否在库中, 若不在, 则进行插桩</span><br><span class="line">        INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)docount, IARG_END); </span><br><span class="line">&#125;</span><br><span class="line">VOID Image(IMG img, VOID* v)</span><br><span class="line">&#123;</span><br><span class="line">    if (IMG_IsMainExecutable(img))</span><br><span class="line">    &#123;</span><br><span class="line">        exe_start = IMG_StartAddress(img);</span><br><span class="line">        exe_size = IMG_SizeMapped(img);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br><span class="line">VOID Fini(INT32 code, VOID* v) &#123; </span><br><span class="line">    cerr &lt;&lt; &quot;Count &quot; &lt;&lt; ins_count &lt;&lt; &quot; &quot; &lt;&lt; exe_start &lt;&lt; &quot; &quot; &lt;&lt; exe_size + exe_start &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* ===================================================================== */</span><br><span class="line">/* Main                                                                  */</span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    if (PIN_Init(argc, argv))</span><br><span class="line">    &#123;</span><br><span class="line">        return Usage();</span><br><span class="line">    &#125;</span><br><span class="line">    IMG_AddInstrumentFunction(Image, 0);</span><br><span class="line">    INS_AddInstrumentFunction(Instruction, 0);</span><br><span class="line">    PIN_AddFiniFunction(Fini, 0);</span><br><span class="line"></span><br><span class="line">    // Never returns</span><br><span class="line">    PIN_StartProgram();</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* ===================================================================== */</span><br><span class="line">/* eof */</span><br><span class="line">/* ===================================================================== */</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="dynamorio"   >
          <a href="#dynamorio" class="heading-link"><i class="fas fa-link"></i></a><a href="#dynamorio" class="headerlink" title="dynamorio"></a>dynamorio</h5>
      <p>另外一款插桩工具dynamorio.这款工具的爆破其实比pin工具更快, 但是inscount.cpp的指令输出是消息框, 需要自己做一些改动.</p>
<p>这款工具的官方给的代码是有不计算库的选项的.</p>
<p>build官方文档:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://dynamorio.org/page_building.html" >https://dynamorio.org/page_building.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/DynamoRIO/dynamorio.git</span><br><span class="line">cd dynamorio &amp;&amp; mkdir build &amp;&amp; cd build</span><br><span class="line">cmake -G&quot;Visual Studio 15&quot; .. #从这里指定你的VS版本, 2019为16, 2022为17 后面跟上dynamorio的源路径</span><br><span class="line">cmake --build . --config RelWithDebInfo</span><br></pre></td></tr></table></div></figure>

<p>接下来直接打开build/api/samples/DynamoRIO_samples.sln就可以进行写代码编译了</p>
<p>修改后的inscount.cpp:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line">/* ******************************************************************************</span><br><span class="line"> * Copyright (c) 2014-2018 Google, Inc.  All rights reserved.</span><br><span class="line"> * Copyright (c) 2011 Massachusetts Institute of Technology  All rights reserved.</span><br><span class="line"> * Copyright (c) 2008 VMware, Inc.  All rights reserved.</span><br><span class="line"> * ******************************************************************************/</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Redistribution and use in source and binary forms, with or without</span><br><span class="line"> * modification, are permitted provided that the following conditions are met:</span><br><span class="line"> *</span><br><span class="line"> * * Redistributions of source code must retain the above copyright notice,</span><br><span class="line"> *   this list of conditions and the following disclaimer.</span><br><span class="line"> *</span><br><span class="line"> * * Redistributions in binary form must reproduce the above copyright notice,</span><br><span class="line"> *   this list of conditions and the following disclaimer in the documentation</span><br><span class="line"> *   and/or other materials provided with the distribution.</span><br><span class="line"> *</span><br><span class="line"> * * Neither the name of VMware, Inc. nor the names of its contributors may be</span><br><span class="line"> *   used to endorse or promote products derived from this software without</span><br><span class="line"> *   specific prior written permission.</span><br><span class="line"> *</span><br><span class="line"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span><br><span class="line"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span><br><span class="line"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span><br><span class="line"> * ARE DISCLAIMED. IN NO EVENT SHALL VMWARE, INC. OR CONTRIBUTORS BE LIABLE</span><br><span class="line"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span><br><span class="line"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span><br><span class="line"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span><br><span class="line"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span><br><span class="line"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span><br><span class="line"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span><br><span class="line"> * DAMAGE.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/* Code Manipulation API Sample:</span><br><span class="line"> * inscount.cpp</span><br><span class="line"> *</span><br><span class="line"> * Reports the dynamic count of the total number of instructions executed.</span><br><span class="line"> * Illustrates how to perform performant clean calls.</span><br><span class="line"> * Demonstrates effect of clean call optimization and auto-inlining with</span><br><span class="line"> * different -opt_cleancall values.</span><br><span class="line"> *</span><br><span class="line"> * The runtime options for this client include:</span><br><span class="line"> *   -only_from_app  Do not count instructions in shared libraries.</span><br><span class="line"> * The options are handled using the droption extension.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#include &quot;dr_api.h&quot;</span><br><span class="line">#include &quot;drmgr.h&quot;</span><br><span class="line">#include &quot;droption.h&quot;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include&lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">#ifdef WINDOWS</span><br><span class="line">#    define DISPLAY_STRING(msg) dr_messagebox(msg)</span><br><span class="line">#else</span><br><span class="line">#    define DISPLAY_STRING(msg) dr_printf(&quot;%s\n&quot;, msg);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#define NULL_TERMINATE(buf) (buf)[(sizeof((buf)) / sizeof((buf)[0])) - 1] = &#x27;\0&#x27;</span><br><span class="line"></span><br><span class="line">static droption_t&lt;bool&gt; only_from_app(</span><br><span class="line">    DROPTION_SCOPE_CLIENT, &quot;only_from_app&quot;, false,</span><br><span class="line">    &quot;Only count app, not lib, instructions&quot;,</span><br><span class="line">    &quot;Count only instructions in the application itself, ignoring instructions in &quot;</span><br><span class="line">    &quot;shared libraries.&quot;); //把选项加上only_from_app就可以不进行库的计数</span><br><span class="line"></span><br><span class="line">/* Application module */</span><br><span class="line">static app_pc exe_start;</span><br><span class="line">/* we only have a global count */</span><br><span class="line">static uint64 global_count;</span><br><span class="line">/* A simple clean call that will be automatically inlined because it has only</span><br><span class="line"> * one argument and contains no calls to other functions.</span><br><span class="line"> */</span><br><span class="line">static void</span><br><span class="line">inscount(uint num_instrs)</span><br><span class="line">&#123;</span><br><span class="line">    global_count += num_instrs;</span><br><span class="line">&#125;</span><br><span class="line">static void</span><br><span class="line">event_exit(void);</span><br><span class="line">static dr_emit_flags_t</span><br><span class="line">event_bb_analysis(void *drcontext, void *tag, instrlist_t *bb, bool for_trace,</span><br><span class="line">                  bool translating, void **user_data);</span><br><span class="line">static dr_emit_flags_t</span><br><span class="line">event_app_instruction(void *drcontext, void *tag, instrlist_t *bb, instr_t *inst,</span><br><span class="line">                      bool for_trace, bool translating, void *user_data);</span><br><span class="line"></span><br><span class="line">DR_EXPORT void</span><br><span class="line">dr_client_main(client_id_t id, int argc, const char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    dr_set_client_name(&quot;DynamoRIO Sample Client &#x27;inscount&#x27;&quot;,</span><br><span class="line">                       &quot;http://dynamorio.org/issues&quot;);</span><br><span class="line"></span><br><span class="line">    /* Options */</span><br><span class="line">    if (!droption_parser_t::parse_argv(DROPTION_SCOPE_CLIENT, argc, argv, NULL, NULL))</span><br><span class="line">        DR_ASSERT(false);</span><br><span class="line">    drmgr_init();</span><br><span class="line"></span><br><span class="line">    /* Get main module address */</span><br><span class="line">    if (only_from_app.get_value()) &#123;</span><br><span class="line">        module_data_t *exe = dr_get_main_module();</span><br><span class="line">        if (exe != NULL)</span><br><span class="line">            exe_start = exe-&gt;start;</span><br><span class="line">        dr_free_module_data(exe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* register events */</span><br><span class="line">    dr_register_exit_event(event_exit);</span><br><span class="line">    drmgr_register_bb_instrumentation_event(event_bb_analysis, event_app_instruction,</span><br><span class="line">                                            NULL);</span><br><span class="line"></span><br><span class="line">    /* make it easy to tell, by looking at log file, which client executed */</span><br><span class="line">    dr_log(NULL, DR_LOG_ALL, 1, &quot;Client &#x27;inscount&#x27; initializing\n&quot;);</span><br><span class="line">#ifdef SHOW_RESULTS</span><br><span class="line">    /* also give notification to stderr */</span><br><span class="line">    if (dr_is_notify_on()) &#123;</span><br><span class="line">#    ifdef WINDOWS</span><br><span class="line">        /* ask for best-effort printing to cmd window.  must be called at init. */</span><br><span class="line">        dr_enable_console_printing();</span><br><span class="line">#    endif</span><br><span class="line">        dr_fprintf(STDERR, &quot;Client inscount is running\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void</span><br><span class="line">event_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef SHOW_RESULTS</span><br><span class="line">    char msg[512];</span><br><span class="line">    int len;</span><br><span class="line">    len = dr_snprintf(msg, sizeof(msg) / sizeof(msg[0]),</span><br><span class="line">                      &quot;Instrumentation results: %llu instructions executed\n&quot;,</span><br><span class="line">                      global_count);</span><br><span class="line">    DR_ASSERT(len &gt; 0);</span><br><span class="line">    NULL_TERMINATE(msg);</span><br><span class="line">    //DISPLAY_STRING(msg);   //这里是messagebox 把这个数据时间控制台输出就行了</span><br><span class="line">    std::cout &lt;&lt; msg &lt;&lt; std::endl;</span><br><span class="line">#endif /* SHOW_RESULTS */</span><br><span class="line">    drmgr_exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static dr_emit_flags_t</span><br><span class="line">event_bb_analysis(void *drcontext, void *tag, instrlist_t *bb, bool for_trace,</span><br><span class="line">                  bool translating, void **user_data)</span><br><span class="line">&#123;</span><br><span class="line">    instr_t *instr;</span><br><span class="line">    uint num_instrs;</span><br><span class="line"></span><br><span class="line">#ifdef VERBOSE</span><br><span class="line">    dr_printf(&quot;in dynamorio_basic_block(tag=&quot; PFX &quot;)\n&quot;, tag);</span><br><span class="line">#    ifdef VERBOSE_VERBOSE</span><br><span class="line">    instrlist_disassemble(drcontext, tag, bb, STDOUT);</span><br><span class="line">#    endif</span><br><span class="line">#endif</span><br><span class="line">    /* Only count in app BBs */</span><br><span class="line">    if (only_from_app.get_value()) &#123;</span><br><span class="line">        module_data_t *mod = dr_lookup_module(dr_fragment_app_pc(tag));</span><br><span class="line">        if (mod != NULL) &#123;</span><br><span class="line">            bool from_exe = (mod-&gt;start == exe_start);</span><br><span class="line">            dr_free_module_data(mod);</span><br><span class="line">            if (!from_exe) &#123;</span><br><span class="line">                *user_data = NULL;</span><br><span class="line">                return DR_EMIT_DEFAULT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Count instructions. If an emulation client is running with this client,</span><br><span class="line">     * we want to count all the original native instructions and the emulated</span><br><span class="line">     * instruction but NOT the introduced native instructions used for emulation.</span><br><span class="line">     */</span><br><span class="line">    bool is_emulation = false;</span><br><span class="line">    for (instr = instrlist_first(bb), num_instrs = 0; instr != NULL;</span><br><span class="line">         instr = instr_get_next(instr)) &#123;</span><br><span class="line">        if (drmgr_is_emulation_start(instr)) &#123;</span><br><span class="line">            /* Each emulated instruction is replaced by a series of native</span><br><span class="line">             * instructions delimited by labels indicating when the emulation</span><br><span class="line">             * sequence begins and ends. It is the responsibility of the</span><br><span class="line">             * emulation client to place the start/stop labels correctly.</span><br><span class="line">             */</span><br><span class="line">            num_instrs++;</span><br><span class="line">            is_emulation = true;</span><br><span class="line">            /* Data about the emulated instruction can be extracted from the</span><br><span class="line">             * start label using the accessor function:</span><br><span class="line">             * drmgr_get_emulated_instr_data()</span><br><span class="line">             */</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        if (drmgr_is_emulation_end(instr)) &#123;</span><br><span class="line">            is_emulation = false;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        if (is_emulation)</span><br><span class="line">            continue;</span><br><span class="line">        if (!instr_is_app(instr))</span><br><span class="line">            continue;</span><br><span class="line">        num_instrs++;</span><br><span class="line">    &#125;</span><br><span class="line">    *user_data = (void *)(ptr_uint_t)num_instrs;</span><br><span class="line"></span><br><span class="line">#if defined(VERBOSE) &amp;&amp; defined(VERBOSE_VERBOSE)</span><br><span class="line">    dr_printf(&quot;Finished counting for dynamorio_basic_block(tag=&quot; PFX &quot;)\n&quot;, tag);</span><br><span class="line">    instrlist_disassemble(drcontext, tag, bb, STDOUT);</span><br><span class="line">#endif</span><br><span class="line">    return DR_EMIT_DEFAULT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static dr_emit_flags_t</span><br><span class="line">event_app_instruction(void *drcontext, void *tag, instrlist_t *bb, instr_t *instr,</span><br><span class="line">                      bool for_trace, bool translating, void *user_data)</span><br><span class="line">&#123;</span><br><span class="line">    uint num_instrs;</span><br><span class="line">    /* By default drmgr enables auto-predication, which predicates all instructions with</span><br><span class="line">     * the predicate of the current instruction on ARM.</span><br><span class="line">     * We disable it here because we want to unconditionally execute the following</span><br><span class="line">     * instrumentation.</span><br><span class="line">     */</span><br><span class="line">    drmgr_disable_auto_predication(drcontext, bb);</span><br><span class="line">    if (!drmgr_is_first_instr(drcontext, instr))</span><br><span class="line">        return DR_EMIT_DEFAULT;</span><br><span class="line">    /* Only insert calls for in-app BBs */</span><br><span class="line">    if (user_data == NULL)</span><br><span class="line">        return DR_EMIT_DEFAULT;</span><br><span class="line">    /* Insert clean call */</span><br><span class="line">    num_instrs = (uint)(ptr_uint_t)user_data;</span><br><span class="line">    dr_insert_clean_call(drcontext, bb, instrlist_first_app(bb), (void *)inscount,</span><br><span class="line">                         false /* save fpstate */, 1, OPND_CREATE_INT32(num_instrs));</span><br><span class="line">    return DR_EMIT_DEFAULT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="使用python-winpwn进行爆破"   >
          <a href="#使用python-winpwn进行爆破" class="heading-link"><i class="fas fa-link"></i></a><a href="#使用python-winpwn进行爆破" class="headerlink" title="使用python winpwn进行爆破"></a>使用python winpwn进行爆破</h4>
      <p>这里可以用C++ 的windows api来进行爆破, 使用重定向输入和输出创建子进程.</p>
<p>微软的官方文档里面相应的样例代码:</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/procthread/creating-a-child-process-with-redirected-input-and-output" >https://docs.microsoft.com/zh-cn/windows/win32/procthread/creating-a-child-process-with-redirected-input-and-output</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>我使用的是winpwn这个工具来进行爆破, 我稍微看了一下程序创建过程, 本质上还是python去调用windows api, 和C++调用windows API大致一样</p>
<p>爆破脚本:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">from winpwn import *</span><br><span class="line">import threading</span><br><span class="line">from concurrent.futures import ThreadPoolExecutor, Future</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def test(data):</span><br><span class="line">    tmp = data</span><br><span class="line">    cmd = &#x27;&#x27; #your pin.exe path</span><br><span class="line">    module = &#x27;&#x27; #your pintool.dll path</span><br><span class="line">    p = process([cmd, &#x27;-t&#x27;, module, &#x27;--&#x27;, &#x27;.\\low_re.exe&#x27;])</span><br><span class="line">    #p = process([cmd, &#x27;-c&#x27;, module, &#x27;-only_from_app&#x27;, &#x27;--&#x27;, &#x27;.\\low_re.exe&#x27;]) //dynamorio的命令行</span><br><span class="line">    p.recvline()</span><br><span class="line">    p.recvline()</span><br><span class="line">    p.sendline(data)</span><br><span class="line">    data = p.recvuntil(&quot;\n&quot;)</span><br><span class="line">    if (data[0:5] != &quot;Count&quot;):</span><br><span class="line">        data = p.recvuntil(&quot;\n&quot;)</span><br><span class="line">    data = int(data.split(&quot;Count &quot;)[1].split(&quot; &quot;)[0])</span><br><span class="line">    #if (data[0:5] != &quot;Instr&quot;): //dynamorio的输出</span><br><span class="line">        #data = p.recvuntil(&quot;\n&quot;)</span><br><span class="line">    #data = int(re.findall(&#x27;\d+&#x27;, data)[0])</span><br><span class="line">    p.close()</span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line">pool = ThreadPoolExecutor(8)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">testlen = 17</span><br><span class="line"></span><br><span class="line">if (testlen):</span><br><span class="line">    flag = &quot;&quot;</span><br><span class="line">    while len(flag) != testlen:</span><br><span class="line">        tasks = []</span><br><span class="line">        results = []</span><br><span class="line">        for i in range(32, 0x7f):</span><br><span class="line">            data = flag + chr(i) + &#x27;i&#x27; * (testlen - 1 - len(flag))</span><br><span class="line">            tasks.append(pool.submit(test, data))</span><br><span class="line">        for t in tasks:</span><br><span class="line">            results.append(t.result())</span><br><span class="line">        #print(chr(a.index(max(a)) + 32))</span><br><span class="line">        flag += chr(results.index(max(results)) + 32)</span><br><span class="line">        print(flag)</span><br><span class="line">else:</span><br><span class="line">    i = 1</span><br><span class="line">    a = []</span><br><span class="line">    while i &lt; 64:</span><br><span class="line">        a.append(test(i * &#x27;1&#x27;))</span><br><span class="line">        i += 1</span><br><span class="line">    print(a.index(max(a)) + 1)</span><br></pre></td></tr></table></div></figure>

<p>这里值得注意的是, 最后输出的Count xxx 是输出到错误信息里面的, 并且是以’\n’结尾所以不能直接使用recvline().</p>
<p>winpwn部分源代码:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def recvline(self,timeout=None,newline=None):</span><br><span class="line">        if newline is None:</span><br><span class="line">            newline=context.newline #newline=&#x27;\r\n&#x27; </span><br><span class="line">        return self.recvuntil(newline)</span><br></pre></td></tr></table></div></figure>

<p>winpwn调用了win.py </p>
<p>write相关调用:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def write(self,buf=&#x27;&#x27;):</span><br><span class="line">        buf=Latin1_encode(buf)</span><br><span class="line">        length=len(buf)</span><br><span class="line">        written=wintypes.DWORD()</span><br><span class="line">        x=windll.kernel32.WriteFile(self.hWritePipe,buf,length,byref(written),None) //这个就是windows api了</span><br><span class="line">        if x==0:</span><br><span class="line">            raise(EOFError())</span><br><span class="line">        return written.value</span><br></pre></td></tr></table></div></figure>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="https://yimianweishi.github.io">marginal</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="https://yimianweishi.github.io/2022/01/04/SCTF-low-re/">https://yimianweishi.github.io/2022/01/04/SCTF-low-re/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/03/15/d3ctf/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">d3ctf</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/11/17/l3hctf-part-wp/"><span class="paginator-prev__text">l3hctf_part_wp</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SCTF-low-re"><span class="toc-number">1.</span> <span class="toc-text">
          SCTF low_re</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toc-number">1.1.</span> <span class="toc-text">
          出题思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A6%96%E5%85%88python%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">
          首先python源代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%B7%E6%B7%86python"><span class="toc-number">1.1.2.</span> <span class="toc-text">
          混淆python</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E5%8C%96%E4%B8%BAC%E4%BB%A3%E7%A0%81%E5%B9%B6%E4%B8%94%E7%BC%96%E8%AF%91"><span class="toc-number">1.1.3.</span> <span class="toc-text">
          转化为C代码并且编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vmp%E5%8A%A0%E5%A3%B3"><span class="toc-number">1.1.4.</span> <span class="toc-text">
          vmp加壳</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E8%A7%A3"><span class="toc-number">1.2.</span> <span class="toc-text">
          题解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%A7%E4%BF%A1%E9%81%93%E7%88%86%E7%A0%B4%E5%B7%A5%E5%85%B7%E6%9E%84%E5%BB%BA"><span class="toc-number">1.2.1.</span> <span class="toc-text">
          侧信道爆破工具构建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#pin"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">
          pin</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dynamorio"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">
          dynamorio</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8python-winpwn%E8%BF%9B%E8%A1%8C%E7%88%86%E7%A0%B4"><span class="toc-number">1.2.2.</span> <span class="toc-text">
          使用python winpwn进行爆破</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">marginal</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">17</div><div class="sidebar-ov-state-item__name">Archives</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>marginal</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>